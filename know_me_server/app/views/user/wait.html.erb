<h1>
We are waiting for the pussy
</h1>

<script type="text/javascript">
    const webSocketUrl = 'ws://localhost:3000/cable';
    const bodyDiv = document.getElementById('body-id');

    var socket = new WebSocket(webSocketUrl);

    function sendAnswer(){
        var checkedValue = $('#iconSelect:checked').val();
        var hiddenVal = $('#custId').val();
        console.log(checkedValue);
        const msg = {
            command: 'message',
            identifier: JSON.stringify({
                room: 'stuff',
                channel: 'GameChannel'
            }),
            data: JSON.stringify({
                action: 'answer', args: JSON.stringify({
                    answer: checkedValue,
                    question: hiddenVal
                })
            })
        };

        socket.send(JSON.stringify(msg));
    }

    // Renders a specific message
    function renderMessage(messageObject) {
        const messageDiv = document.createElement('div');
        messageDiv.innerHTML = "<form>"
        messageDiv.innerHTML = '<input type="hidden" id="custId" name="custId" value="' + messageObject.question + '">'
        var stuff = messageObject.answers;
        Object.keys(stuff).forEach(function(k) {
            messageDiv.innerHTML += '<input id="iconSelect" name="icon" type="radio" value="' + k + '"/>'
            messageDiv.innerHTML += "<h1>" + k + " - " + stuff[k] + "</h1>";
            console.log(k + " : " + stuff[k]);
        });

        messageDiv.innerHTML += '<input type="button" value="clickme" onclick="sendAnswer();"/> </form>'

        bodyDiv.innerHTML = messageDiv.innerHTML;
    }

    window.onload = function() {
        // When the connection is 1st created, this code runs subscribing the clien to a specific chatroom stream in the ChatRoomChannel
        socket.onopen = function(event) {
            console.log('WebSocket is connected.');

            const msg = {
                command: 'subscribe',
                identifier: JSON.stringify({
                    room: 'stuff',
                    channel: 'GameChannel'
                }),
            };

            socket.send(JSON.stringify(msg));
        };

        // When the connection is closed, this code is run
        socket.onclose = function(event) {
            console.log('WebSocket is closed.');
        };

        // When a message is received through the websocket, this code is run
        socket.onmessage = function(event) {            
            const response = event.data;
            const msg = JSON.parse(response);
            
            // Ignores pings
            if (msg.type === "ping") {
                return;
            } 

            console.log("FROM RAILS: ", msg);
            
            // Renders any newly created messages onto the page
            if (msg.message) {
                const msg_v2 = JSON.parse(msg.message);
                renderMessage(msg_v2)
            }
            
        };
        
        // When an error occurs through the websocket connection, this code is run printing the error message
        socket.onerror = function(error) {
            console.log('WebSocket Error: ' + error);
        };
    };
</script>